<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.js"></script>
    </head>
    <body>
        <script>
            //VARIABLES
            var config={
                type: Phaser.AUTO,
                width: 1200,
                height: 800,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: {y : 0}
                    }
                },
                scene: {
                    preload: preload, //carga los recursos que necesitamos para nuestro juego
                    create: create,
                    update: update
                }
            }

            var game= new Phaser.Game(config);

            var fondo;
            var player;
            var combo;
            var comboBoton;
            var comboContador;
            var teclasJugador1;
            var spritesBotones;
            var spritesLetras;

            //Posicion Botones Jugador 1
            var posBoton1X = 100;
            var posBoton1Y = 200;
            var posNextBoton = 75;
            
            //FUNCIONES 
            function preload (){
                
                //Carga de los sprites de los botones
                this.load.image('W','../resources/img/Buttons/Boton_Amarillo.png');
                this.load.image('A','../resources/img/Buttons/Boton_Azul.png');
                this.load.image('S','../resources/img/Buttons/Boton_Verde.png');
                this.load.image('D','../resources/img/Buttons/Boton_Naranja.png');

                this.load.spritesheet('Tipografia_Botones', 
                    '../resources/img/Buttons/Tipografía Botones.png',
                    {frameWidth: 256, frameHeight: 256})

                //Carga del spite de Yacuza
                this.load.spritesheet('Yacuza_idle',
                    '../resources/img/characters/Yacuza/Yacuza_Animacion_1.png',
                    {frameWidth: 768, frameHeight: 768}
                );
                this.load.spritesheet('Yacuza_punch',
                    '../resources/img/characters/Yacuza/Yacuza_Animacion_2.png',
                    {frameWidth: 700, frameHeight: 700}
                );

                //Carga imagen del background
                this.load.image('background', 'Escenario_2.png');
            }
            function create ()
            {
                var bg = this.add.image(0, 0, 'background');
                bg.setOrigin(0,0);
                //bg.setScale(1.5);

                player = this.physics.add.sprite(225, 525, 'Yacuza');
                //player.setScale(1.5);
                
                this.anims.create({
                    key: 'Yacuza_animacion_idle',
                    frames: this.anims.generateFrameNumbers('Yacuza_idle', {start: 0, end: 1}),
                    frameRate: 3,
                    repeat: -1
                });

                //Inicializar cada tecla que se vaya a usar
                var W = new Tecla(this.input.keyboard.addKey('W'), 1, 'W', 'Tipografia_Botones'); 
                var A = new Tecla(this.input.keyboard.addKey('A'), 1, 'A', 'Tipografia_Botones');
                var S = new Tecla(this.input.keyboard.addKey('S'), 1, 'S', 'Tipografia_Botones');
                var D = new Tecla(this.input.keyboard.addKey('D'), 1, 'D', 'Tipografia_Botones');
                
                //Array de teclas que usa el jugador 1
                teclasJugador1 = [W,A,S,D]; 

                comboBoton = 4;
                combo = [];
                spritesBotones = [];
                spritesLetras = [];
            }

            function update ()
            {   
                //GameLoop en proceso
                if(comboBoton == 4)
                {
                    if(spritesBotones[0] != null)
                    {
                        for (let i = 0; i < spritesBotones.length; i++) {
                            spritesBotones[i].destroy();
                            spritesLetras[i].destroy();
                        }
                        comboContador++;
                    }
                    comboBoton = 0;

                    //Crea un array donde guarda el combo generado aleatoriamente con las teclas creadas
                    for (let i = 0; i < 4; i++) {
                        var random = Phaser.Math.Between(0, 3);
                        combo[i] = teclasJugador1[random];
                        spritesBotones[i] = this.add.sprite(posBoton1X + (posNextBoton * i), posBoton1Y, combo[i].sprite);
                        spritesBotones[i].setScale(3);
                        //var text = this.add.text(spritesBotones[i].x -10, spritesBotones[i].y - 15, combo[i].text, {fontSize: '32px', fill: '#000'});
                        spritesLetras[i]= this.add.sprite(spritesBotones[i].x , spritesBotones[i].y, combo[i].text);
                        spritesLetras[i].setFrame(random);
                    }
                }
                
                //Añadir lo que ocurre cuando vas haciendo combos seguidos
                
                if(Phaser.Input.Keyboard.JustDown(combo[comboBoton].key))
                {
                    spritesBotones[comboBoton].setAlpha(0.5);
                    spritesLetras[comboBoton].setAlpha(0.5);

                    comboBoton++;
                }else if(Phaser.Input.Keyboard.JustDown(teclasJugador1[0].key) || Phaser.Input.Keyboard.JustDown(teclasJugador1[1].key)
                            || Phaser.Input.Keyboard.JustDown(teclasJugador1[2].key) || Phaser.Input.Keyboard.JustDown(teclasJugador1[3].key))
                {
                    //reset combo
                    comboBoton = 0;
                    comboContador = 0;
                    for (let i = 0; i < spritesBotones.length; i++) {
                        spritesBotones[i].destroy();
                        spritesLetras[i].destroy();
                    }
                    //Crea un array donde guarda el combo generado aleatoriamente con las teclas creadas
                    for (let i = 0; i < 4; i++) {
                        var random = Phaser.Math.Between(0, 3);
                        combo[i] = teclasJugador1[random];
                        spritesBotones[i] = this.add.sprite(posBoton1X + (posNextBoton * i), posBoton1Y, combo[i].sprite);
                        spritesBotones[i].setScale(3);
                        //var text = this.add.text(spritesBotones[i].x -10, spritesBotones[i].y - 15, combo[i].text, {fontSize: '32px', fill: '#000'});
                        spritesLetras[i]= this.add.sprite(spritesBotones[i].x , spritesBotones[i].y, combo[i].text);
                        spritesLetras[i].setFrame(random);
                    }

                    //penalizacion 
                }
                
                player.anims.play('Yacuza_animacion_idle', true);
            }

            //Generador de Teclas
            function Tecla(key, damage, sprite, text, sonido, animation) 
            {
                this.key = key;
                this.damage = damage;
                this.sprite = sprite;
                this.text = text;
                this.sonido = sonido;
                this.animation = animation;
            }
        </script>
    </body>
</html>
